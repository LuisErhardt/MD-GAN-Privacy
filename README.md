# Attacks and Defenses for Free-Riders in Multi-Discriminator GAN 

This repo is the testbed for paper ***Attacks and Defenses for Free-Riders in Multi-Discriminator GAN***. The demo shown here is the DFG+ defense on CIFAR10. The code contains three parts: `Server`, `BenignClient` and `Attacker`. The server is the generator. The `BenignClient` and `Attacker` are the discriminators (or free-riders). The testbed is a distributed framework realised on Pytorch RPC. The generator and discriminator can be placed on different computers, as long as they can communicate via internet. I will first introduce how to train the DSG+ algorithm (using CIFAR10 dataset as a demo). Then explain how to evaluate the results (i.e., Frechet Inception Distance (FID)) in the same way as we showed in the paper.

## Training process


### Generator
Since we use Pytorch RPC as our communication method, here are some parameters we need to provide to organize the MD-GAN. For example, to run the demo with CIFAR10 dataset with one benign client and one free-rider, we can first enter folder `Server` and type the following command:
```
python3 Server_DFGPlus_CIFAR10.py -ip 131.180.41.146 -rank 0 -epochs 100 -batch_size 500 -n_critic 5 -world_size 3 -dataset cifar10
```
There are several parameters in this command. `ip` is the ip of the **server**. `rank` indicates the rank of the current runner. It's important to set `rank` as **0** for running server. `epoch` is self-explained, it is the training epoch number, but be careful, the epoch here equals to the notion `round` in the paper. `world_size` is the number of clients plus one server. For instance, here we set `world_size` to 3, it means we will have two clients. `dataset` is the name of training dataset that we will use in the **client** side. For this demo, the CIFAR10 dataset will be downloaded automatically by torchvision library if the CIFAR10 dataset is not available locally. 

### BenignClient and Attacker
Under `BenignClient` folder, we have the script `benign_client.py`. For client to join the MD-GAN, under `BenignClient` folder, run:
```
python3 benign_client.py -ip 131.180.41.146  -rank 1 -epochs 100 -batch_size 500 -n_critic 5 -world_size 3
```
And for free-rider to join the MD-GAN training, under `Attacker` folder, run
```
python3 attacker.py -ip 131.180.41.146  -rank 2 -epochs 100 -batch_size 500 -n_critic 5 -world_size 3
```
No matter it is benign client or free-rider, they are just discriminators. The only difference between the parameters is the `-rank`. We need to make sure each node in the MD-GAN has its own unique rank. For `N` clients, their ranks should start from **1** to **N** without repetitions. And the `ip` is the server's ip.

### Network configuration
1. We tested our code under Ubuntu20.04. Under `/etc/hosts`, change ip `127.0.1.1` to the current ip in the subnet. We need to do that both in server and client computers.

2. Also needs to allow all the connections from each other. Using following commands:
```
Server : sudo ufw allow from [Client IP]
Client : sudo ufw allow from [Server IP]
```
Be careful, even though we specify the port that RPC should use is 7788 in our code, but Pytorch RPC library open more ports in the backend. Only allow port 7788 is not enough for server and client connection.
### Possible Training error
On the Linux system where we implement our experiment, one possible error is 
```
RuntimeError: ECONNREFUSED: connection refused
```
This is because we use Gloo as backend. By default, Gloo backend will try to find the right network interface to use. But sometimes it's not correct. In that case, we need to override it with:
```
export GLOO_SOCKET_IFNAME=eth0
```
`eth0` is your network interface name, you may need to change it. Use ```ifconfig``` in the terminal to check the name.


### Output
The above training process will generate data under  `Server/data/` folder. The output will be different folders with name starts with `cifar100-epoch`. For instance, for a folder named `cifar100-epoch89`, it contains the intermediate images generated by generator at 89th round. Each folder possesses 10 000 images. Each 5 round, it will generate one folder like that.

## Evaluation of the result
### Data preparation
We use Frechet Inception Distance (FID) to evaluate the quality of generated images. Since FID calculates the statistic distance between generated images and original ones. We need to first prepare all the training images from CIFAR10. Under `Server` folder, run:
```
python3 prepare_CIFAR10_images.py
```
The above script will download and normalize all CIFAR10 training images under `Server/cifar10/` folder.
### FID evaluation
Once we download all the CIFAR10 training images, we can run:
```
python3 FID_evaluation_CIFAR10.py
```
under `Server` folder. The evaluation will take several minutes, and it uses GPU by default. Otherwise, it will be super slow. In the end, the script will generate a csv file
`FID_CIFAR10_1BENIGN_1ATTACKER_ROUND1.csv`. The result looks like that:
|FID score| 
|-----------|
|384.1908656048|
|395.974548617906|
|225.70792921604|
|176.313450195732|
|142.246675742448|
|131.547368923991|
|150.555723794053|
|145.401958712123|
|142.866538539177|
|127.207525711663|
|120.778104742674|
|124.764800242802|
|120.338798692791|
|109.9917126344|
|101.427683191758|
|99.4117357135023|
|89.5865215545948|
|85.1635683439266v
|84.8649495348915|
|76.6063171364378|

which contains 20 values, range from 5th round output to 100th output, where the interval is 5 rounds.

### Precision and Recall
The training will generate also file named `IGNORE_CLIENTS_5000ROWS_5CLIENT_1ATTACKER_ROUND1.csv` under `Server` folder, it contains all the filtered out clients ID. To calculate precision and recall, we can simply run:

```
python3 precision_recall.py IGNORE_CLIENTS_5000ROWS_5CLIENT_1ATTACKER_ROUND1.csv 5
```
The number `5` is to indicate how many attackers in the experiment. The script will output numbers as:
```
precision, recall:  48.0 26.67
```
Be careful, the script is currently only working for 5 benign clients + n free-riders, and the benign clients ID are from 0 to 4. If you have other setup, you need to adjust this script.

### Correct & Wrong permission and prevention
The training will generate also files named 
`ATTEMPTED_SWITCH_5000ROWS_5CLIENT_1ATTACKER_ROUND1.csv` and `SUCCESS_SWITCH_5000ROWS_5CLIENT_1ATTACKER_ROUND1.csv` under `Server` folder.
Former file contains all the swapping request within all the clients. Later file contains all the permitted swapping request. To calculate if all the swapping are benign or malicious, run:
```
python prevention_permission_evaluation.py ATTEMPTED_SWITCH_5000ROWS_5CLIENT_1ATTACKER_ROUND1.csv SUCCESS_SWITCH_5000ROWS_5CLIENT_1ATTACKER_ROUND1.csv
```
It will output something like:
```
('total action: ', 27)
('correct prevention: ', 25)
('correct permission: ', 3)
('wrong prevention: ', 2)
('wrong permission: ', 0)
```
which are the statistic of DFG+ defense.
